////
; Copyright (c) uib gmbh (www.uib.de)
; This documentation is owned by uib
; and published under the german creative commons by-sa license
; see:
; http://creativecommons.org/licenses/by-sa/3.0/de/
; http://creativecommons.org/licenses/by-sa/3.0/de/legalcode
; english:
; http://creativecommons.org/licenses/by-sa/3.0/
; http://creativecommons.org/licenses/by-sa/3.0/legalcode
;
; credits: http://www.opsi.org/credits/
////

:Author:    uib gmbh
:Email:     info@uib.de
:Date:      25.1.2018
:Revision:  4.1.0
:toclevels: 6

include::../common/opsi_terms.asciidoc[]

[[opsi-manual-vhd]]
=== 'opsi vhd reset

[[opsi-manual-vhd-preconditions]]
==== Vorbedingungen für die opsi Erweiterung 'opsi vhd reset

Dieses Modul ist momentan eine
http://www.uib.de/www/kofinanziert/index.html[kofinanzierte opsi Erweiterung]. +
Es ist gebundelt mit der Erweiterung 'opsi-local-image' - das heist: die Freischaltung für 'opsi-local-image' gilt auch für 'opsi-vhd-reset'. +
Es sind eine Reihe von Vorbedingungen nötig, um dieses Modul einsetzen
zu können. Das bedeutet, dass Sie zum Einsatz eine Freischaltdatei benötigen. Diese Freischaltung erhalten Sie, wenn Sie die Erweiterung kaufen. Zu Evaluierungszwecken stellen wir Ihnen auch eine zeitlich befristete Freischaltung kostenlos zur Verfügung ( -> mail an info@uib.de). +

////
Weitere Details hierzu finden Sie in <<opsi-manual-modules>>.
////

Technische Voraussetzungen sind opsi >= 4.0.7 mit den Paketständen:

.Benötigte Pakete
[options="header"]
|==========================
|opsi-Paket|Version
|opsi-winst |>= 4.12.0.13
|==========================


[[opsi-manual-vhd-introduction]]
==== Einführung

Um in Schulungsräumen Rechner innerhalb von kurzer Zeit wie z.B. in einer Pause zwischen zwei Kursen wieder in einen definierten Zustand zu versetzen bedarf es besonderer Mittel. Mit 'opsi-local-image' bietet opsi hier bereits etwas an,
das nun ergänzt wird durch eine neue Methode welche spezifische Vor- und Nachteile hat.

. Initiale Windows 10 Installation in einen VHD Container
. 'Versiegelung' der initialen Installation durch eine 'child' VHD
. Schnelle Wiederherstellung durch austausch der 'child' VHD.
. Upgrade der initialen Installation durch einen merge der 'child' VHD.
. Das Verfahren arbeitet mit den aus der Virtualisierung bekannten snapshot Techniken ohne selbst eine Virtualisierung zu benötigen.



[[opsi-manual-vhd-proceedings]]
==== Abläufe

[[opsi-manual-vhd-proceedings-initial]]
===== Initiale Installation

Über das Produkt `opsi-vhd-win10-x64` ein Windows 10 in einen VHD-Container installiert.

.Schema: Initiale Installation 1: Erstellen der VHD
image::opsi-vhd-inst1.png["Schema: Initiale Installation  mit opsi-vhd-win10-x64", width=332]

.Schema: Initiale Installation 2: Windows Installation
image::opsi-vhd-inst2.png["Schema: Initiale Installation  mit opsi-vhd-win10-x64", width=332]

Anschließend können in dieses Windows die gewünschten Applikationen installiert werden.

.Schema: Initiale Installation 3: Software Installation
image::opsi-vhd-inst3.png["Schema: Initiale Installation  mit opsi-vhd-win10-x64", width=332]

Durch einen Aufruf des opsi Produktes 'opsi-vhd-control' werden zunächst die aktuellen opsi Meta Daten zu diesem Client (welches Produkt ist in welcher Version installiert) in der initialen Installation abgeleget. +
Anschließend wird für die weitern Vorgänge das Windows PE aktiviert und gebootet.

.Schema: Initiale Installation 4: Aktivierung der PE Partition
image::opsi-vhd-inst4.png["Schema: Initiale Installation  mit opsi-vhd-win10-x64", width=332]

Vom Windows PE aus wird durch anlegen einer Child VHD die initiale Installation gegen Veränderungen geschützt.

.Schema: opsi-vhd-control: Versiegelung der Initalen Installation
image::opsi-vhd-control-1stsnap.png["Schema: Versiegelung der Initalen Installation  mit opsi-vhd-control", width=332]

Änderungen landen ab jetzt in der 'child' VHD.

.Schema: Arbeiten mit dem 'versiegelten' System
image::opsi-vhd-control-work.png["Schema: Arbeiten mit dem 'versiegelten' System", width=332]


[[opsi-manual-vhd-proceedings-restore]]
===== Schnelle Wiederherstellung

Über das opsi Produkt 'opsi-vhd-control' kann die Initiale Installation wieder hergestellt werden. +
Zunächst werden die gespeicheten opsi Meta Daten aus dem System wiederhergestellt.
Dann wird für das Child VHD handling wieder in das Windows PE gebootet.

.Schema: opsi-vhd-control: Wiederherstellung der Initalen Installation 1
image::opsi-vhd-control-activatepe.png["Schema: Wiederherstellung der Initalen Installation  mit opsi-vhd-control 1", width=332]

Vom Windows PE aus wird die 'child' VHD mit den Veränderungen gelöscht und gegen eine neue, leere 'child' VHD ausgetauscht.

.Schema: opsi-vhd-control: Wiederherstellung der Initalen Installation 2
image::opsi-vhd-control-resnap.png["Schema: Wiederherstellung der Initalen Installation  mit opsi-vhd-control 1", width=332]


[[opsi-manual-vhd-proceedings-update]]
==== Update eines Images

Für ein Update der initialen Installtion mit Patches und Softwareupdates, kann wie folgt vorgegangen werden:

* Wiederherstellung der initialen Installation (wie oben beschrieben)
* Einspielen der Updates
* Integration der Updates in die initiale Installation und Neuversiegelung durch 'opsi-vhd-control'
* Ablegen der neuen opsi Meta Daten im System


[[opsi-manual-vhd-components]]
==== Die opsi-vhd Produkte

Die Erweiterung 'opsi vhd reset' besteht aus folgenden Produkten

Das Netbootprodukt zur initialen Installation

* `opsi-vhd-win10-x64`

Es gibt auch eine 32 Bit Version. Diese ist aufgrund eines Problems beim Diskpart merge Befehls in den 32 Windows PE Versionen nur eingeschränkt verwendbar. +
Theoretisch wäre auch eine Implementierung für Windows 8.1 bzw Windows 7 Enterprise möglich. Diese werden wir aber nur auf Bedarf anfertigen.

Das Localboot Produkt zur Steuerung der Erstellung, des Austausch und des Merge der Child-VHD's.

* `opsi-vhd-control`


[[opsi-manual-vhd-components-uefi]]
===== UEFI Kompatibilität

Die opsi-vhd Produkte sind UEFI kompatibel.


[[opsi-manual-vhd-components-netboot]]
===== Das opsi Netboot Produkt 'opsi-vhd-win10-x64' und seine Properties

Diese Netbootprodukt gleicht vom Aufbau her den normalen Netbootprodukten (4.1.0) zur Windows Installation
und muß entsprechend befüllt werden wie dies im 'Getting-started' Handbuch beschrieben ist. +
Auch die Properties sind weitgehend die selben. 


Folgende Properties sind speziell für dieses Produkt:

* `windows_vhd_size` +
Dieses Property gibt die Größe der Basis VHD absolut oder in Prozent der Festplattengröße
abzüglich der WinPE Partition an. Der Defaultwert von 100% wird automatisch auf 80 % gekürzt,
um Platz für die child VHD zu lassen. Wird (absolut oder relativ) ein Wert angegeben der über 80% landet,
so wird dieser auch auf 80% vermindert. +
Dieses Property ersetzt das Standard Property 'windows_partition_size' (Default = 100%)

* `installto`: +
Der Wert ist 'vhd' und soll und kann auch nicht geändert werden

Folgende Properties fehlen bei diesem Produkt:

** `windows_partition_size` +
Siehe oben
** `data_partition_size` +
Die Verwaltung einer Data-Partition ist bisher bei opsi-vhd nicht vorgesehen.
`start_os_installation` +
Hier kann das Produkt zur Installation eines Betriebssystems ausgewählt werden, welches im Anschluß an die Partitionierung automatisch gestartet wird.
Bei der Installation dieses Produkts werden beim Produkt `opsi-local-image-restore` die Produktproperties 'imagefile' und 'imagefiles_list' gelöscht, da durch die Neupartitionierung diese Daten ungültig geworden sind.
** `delay_for_reboot` +
Sekunden zwischen Beendigung des Scriptes und dem Reboot um dem Server Zeit zugeben die Netboot-Pipe zu erstellen.
** `minimal_backup_partition_size` +
Diese Property dient zu einer Plausibilitätsüberprüfung der gemachten Angaben. +
Die Größe der Backuppartition ergibt sich aus: +
Größe der Festplatte - (`system_partition_size` + `data_partition_size` + `winpe_partition_size`). +
Üblicherweise verwendet man opsi-local-image, weil ein lokales Backup der Systempartition gemacht werden soll. Dazu ist Voraussetzung, das für die Backuppartition genügend Platz ist. Wird bei der Berechnung der Partitionierung festgestellt das der verbleibende Platz für die Backuppartition kleiner ist als der Wert von `minimal_backup_partition_size` wird mit einem Fehler abgebrochen. +
(Default=55%)
** `winpe_partition_size`: Größe der winpe Partition (Default=4G)

[[opsi-manual-vhd-components-control]]
===== Netboot Produkte zur Installation von Windows

Die Netbootprodukte zur Installation von Windows sind Abkömmlinge der opsi Standardprodukte zur Windowsinstallation. Das bedeutet konkret, dass sie bezüglich des Aufbaus und der Treiberintegration identisch sind. Entsprechende Anleitungen finden sich im 'opsi-getting-started' Handbuch.

* `opsi-local-image-winxp` +
Installation von Windows XP. Verwendet nur die erste Partition.
Administrator Passwort ist leer.

* `opsi-local-image-win7` +
Installation von Windows 7 32 Bit.
Administrator Passwort = `nt123`.

* `opsi-local-image-win7-x64` +
Installation von Windows 7 64 Bit.
Administrator Passwort = `nt123`.

* `opsi-local-image-win81` +
Installation von Windows 8.1 32 Bit.
Administrator Passwort = `nt123`.

* `opsi-local-image-win81-x64` +
Installation von Windows 8.1 64 Bit.
Administrator Passwort = `nt123`.

* `opsi-local-image-win10` +
Installation von Windows 10 32 Bit.
Administrator Passwort = `nt123`.

* `opsi-local-image-win10-x64` +
Installation von Windows 10 64 Bit.
Administrator Passwort = `nt123`.

Diese Produkte haben folgende 'opsi-local-image' spezifische Properties:

* 'backup_after_install' mit dem default Wert 'true'. Dies bedeutet in diesem Fall, dass nach der OS Installation zunächst die Anwendungssoftware installiert wird und abschließend eine Imagesicherung der Installation durchgeführt wird. Weiterhin wird der Wert vom `imageFile` des Produktes `opsi-local-image-restore` gelöscht. Dies führt dazu, dass das erstellte Backup den Namen des laufenden Netbootproduktes (z.B. `opsi-local-image-win7`) bekommt.

* 'setup_after_install' +
Hier können ein oder mehrere Produkte angegeben werden, welche nach Abschluß der Betriebssysteminstallation auf 'setup' gestellt werden. Dabei werden auch die Abhängigkeiten diese Produkte mit aufgelöst.

